{% extends "base.html" %}

{% block additionalHeaders %}<script src="http://yui.yahooapis.com/3.4.0/build/yui/yui-min.js"></script>

<script type="text/javascript">
YUI().use('node','event','io','json-parse', function (Y) {
    Y.on('domready', function(e) {
        // Access DOM elements.
        var submit = Y.one('#submit'),
            input   = Y.one('#id_input'),
            select = Y.one('#id_scraper'),
            form = Y.one('form'),
            subcontent = Y.one('#subcontent');
        var global_cache = {};
    
        function busyStart(onlyBar) {
            if (!onlyBar) {
                submit.set('disabled',true);
                input.set('disabled',true);
                select.set('disabled',true);
                submit.set('value','Please wait...');
            }
            subcontent.setContent('<img class="center" src="{{ STATIC_URL }}img/ajax-loader.gif" alt="Loading" />');
        }
        
        function busyStop() {
            submit.set('disabled',false);
            input.set('disabled',false);
            select.set('disabled',false);
            submit.set('value','Fetch');
        }
        
        function makeQueryFromInput(e) {
            e.preventDefault();
            if (input.get('value') != '') {
                var cfg = {
                    method: 'GET',
                    form: {
                        id: form,
                        useDisabled: true,
                    },
                    on: {
                        success: function(id, o, args) {
                            var response = Y.JSON.parse(o.responseText);
                            getResult(response.result_url, response.result_id);
                        },
                        failure: function(id, o, args) {
                            if (o.status == 400) {
                                subcontent.setContent('<div class="alert alert-error">The input field is required.</div>')
                            } else {
                                subcontent.setContent('<div class="alert alert-error">A general error occured. Please try again later.</div>')
                            }
                            busyStop();
                        }
                    },
                    headers: { 'Accept': 'application/json' }
                };
                
                busyStart(false);
                // Start the transaction.
                Y.io('{% url api_v1_makequery %}', cfg);
            }
        };
        
        function makeQueryFromLink(e) {
            e.preventDefault();
            
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        var response = Y.JSON.parse(o.responseText);
                        getResult(response.result_url, response.result_id);
                    },
                    failure: function(id, o, args) {
                        subcontent.setContent('<div class="alert alert-error">A general error occured. Please try again later.</div>')
                        busyStop();
                    }
                },
                headers: { 'Accept': 'application/json' }
            };
            
            busyStart(false);
            Y.io(this.getAttribute('data-query-url'), cfg);
        };
        
        function changeFormat(e) {
            var format_form = this.get('parentNode'),
                url = format_form.get('action'),
                textarea = Y.Node.one('textarea#description_area'),
                loading_image = Y.Node.create('<img id="format_loading" src="{{ STATIC_URL }}img/ajax-loader.gif" alt="Loading" />'),
                format = this.get('value'),
                download_link = Y.Node.one('a#download_link');
            
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        var data = Y.JSON.parse(o.responseText);
                        args.download_link.set('href',args.download_link.get('href').replace(/[\w\d-]+$/,args.format));
                        
                        if (data.status == 'done' && data.type == 'release') {
                            args.textarea.set('value',data.description);
                            global_cache[args.format] = data.description;
                        }
                        
                        args.textarea.set('disabled',false);
                        args.select.set('disabled',false);
                        args.loading_image.remove();
                    },
                    failure: function(id, o, args) {
                        args.textarea.set('disabled',false);
                        args.select.set('disabled',false);
                        args.loading_image.remove();
                    }
                },
                arguments: {
                    select: this,
                    textarea: textarea,
                    loading_image: loading_image,
                    format: format,
                    download_link: download_link
                },
                headers: { 'Accept': 'application/json' }
            };
            
            if (format in global_cache) {
                textarea.set('value',global_cache[format]);
                download_link.set('href',download_link.get('href').replace(/[\w\d-]+$/,format));
            } else {
                textarea.set('disabled',true);
                this.set('disabled',true);
                format_form.append(loading_image);
                
                Y.io(url + '?description_format=' + encodeURIComponent(format), cfg);
            };
        }
        
        function getResult(result_url, result_id) {
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        //invalidate the cache
                        global_cache = {};
                        
                        var data = JSON.parse(o.responseText);
                        
                        if (data.status == "done") {
                            if (data.type == 'release') {
                                var textarea = Y.Node.create('<textarea id="description_area"></textarea>');
                                textarea.addClass('description_area');
                                textarea.set('value',data.description);
                                
                                var div = Y.Node.create('<div></div>');
                                div.addClass('well');
                                div.insert(textarea,'replace');
                                
                                var download_link = Y.Node.create('<a href="{% url download_result "121212" "whatcd" %}" id="download_link" class="btn">Download as .txt</a>'.replace(/121212/,args.result_id));
                                div.append(download_link);
                                
                                var format_form = Y.Node.create('{% with format_form=FORMAT_FORM %}{% spaceless %}{% include "format_form.html" %}{% endspaceless %}{% endwith %}');
                                format_form.set('action',result_url);
                                format_form.one('#id_description_format').on('change',changeFormat);
                                
                                div.append(format_form);
                                
                                subcontent.setContent(div);
                            } else if (data.type == 'release_list') {
                                var ul = Y.Node.create('<ul id="release_list"></ul>');
                                
                                var scraper_results = data.releases;
                                for (scraper in scraper_results) {
                                    var release_list = scraper_results[scraper];
                                    for (var i = 0; i < release_list.length;i++) {
                                        var name = release_list[i]['name'],
                                            info = release_list[i]['info'],
                                            query_url = release_list[i]['query_url'],
                                            release_url = release_list[i]['release_url'];
                                        
                                        var li = Y.Node.create('<li></li>');
                                        var a = Y.Node.create('<a href="{% url index %}' + '?input=' + encodeURIComponent(release_url) +'">'+name+'</a>');
                                        a.setAttribute('data-query-url', query_url);
                                        a.on('key', makeQueryFromLink, 'press:enter');
                                        a.on('click', makeQueryFromLink);
                                        
                                        li.append(a);
                                        li.append('<br />')
                                        li.append('<span class="label">' + info + '</label>');
                                        
                                        ul.append(li);
                                    }
                                };
                                
                                if (ul.all('*').size() != 0) {
                                    var div = Y.Node.create('<div></div>');
                                    div.addClass('well');
                                    div.setContent(ul)
                                    
                                    subcontent.setContent(div);
                                } else {
                                    subcontent.setContent('<div class="alert alert-error">Sorry, there were no matches.</div>');
                                }
                            } else if (data.type == 'release_not_found') {
                                subcontent.setContent('<div class="alert alert-error">I could not find the release with the given ID. You may want to try again with another one.</div>');
                            } else {
                                subcontent.setContent(o.responseText);
                            }
                            busyStop();
                        } else {
                            var delay = function() { getResult(args.result_url, args.result_id); };
                            window.setTimeout(delay, 1000);
                        }
                    },
                    failure: function(id, o, args) {
                        if (o.status == 503) {
                            subcontent.setContent('<div class="alert alert-error">An error occured while retrieving the data. This might be a temporary problem. Try again in a few minutes.</div>');
                        } else if (o.status == 404) {
                            subcontent.setContent('<div class="alert alert-error">Something happened that should not happen. Please try again.</div>');
                        } else {
                            subcontent.setContent('<div class="alert alert-error">A general error occured. Please try again later.</div>');
                        }
                        busyStop();
                    }
                },
                arguments: {
                    result_url: result_url,
                    result_id: result_id
                },
                headers: { 'Accept': 'application/json' }
            };
            
            //circumvent IE's ajax caching
            if (Y.UA.ie > 0) {
                var date = new Date();
                var timestamp = date.getTime();
                
                if (result_url.charAt(result_url.length-1) == '/') {
                    result_url += '?';
                } else {
                    result_url += '&';
                }
                
                result_url += 'stupid_ie=' + timestamp;
            }
            
            Y.io(result_url, cfg);
        };
        
        input.on('key', makeQueryFromInput, 'press:enter');
        submit.on('key', makeQueryFromInput, 'press:enter');
        submit.on('click', makeQueryFromInput);
        
        //there may already be a release list on the page
        var release_links = Y.all('#release_list li a');
        
        //alter the default events for each link
        release_links.each( function(node,index,nodelist) {
            node.on('key', makeQueryFromLink, 'press:enter');
            node.on('click', makeQueryFromLink);
        });
        
        var format_select = Y.all('#id_description_format');
        format_select.each(function(node,index,nodelist) {
            node.on('change',changeFormat);
        });
    });
});
</script>
{% endblock %}

{% block content %}{% include "input_form.html" %}
<div id="subcontent">{% block subcontent %}{% endblock %}</div>{% endblock %}