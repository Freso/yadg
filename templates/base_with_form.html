{% extends "base.html" %}

{% block additionalHeaders %}<script src="http://yui.yahooapis.com/3.4.0/build/yui/yui-min.js"></script>

<script type="text/javascript">
YUI().use('node','event','io','json-parse', function (Y) {
    Y.on('domready', function(e) {
        // Access DOM elements.
        var submit = Y.one('#submit'),
            input   = Y.one('#id_input'),
            form = Y.one('form'),
            subcontent = Y.one('#subcontent');
    
        var input_string = 'Enter discogs url or search term';
    
        function busyStart(onlyBar) {
            if (!onlyBar) {
                submit.set('disabled',true);
                input.set('disabled',true);
                submit.set('value','Please wait...');
            }
            subcontent.setContent('<img class="center" src="{{ STATIC_URL }}ajax-loader.gif" alt="Loading" />');
        }
        
        function busyStop() {
            submit.set('disabled',false);
            input.set('disabled',false);
            submit.set('value','Fetch');
        }
        
        function restoreInputDefaultValue(e) {
           if ( input.get('value') == '' ) {
            input.set('value',input_string);
           }
        };
    
        input.set('value',input_string);
        
        input.on('focus', function(e) {
           if ( input.get('value') == input_string ) {
            input.set('value','');
           }
        });
        
        input.on('clickoutside', restoreInputDefaultValue );
        input.on('key', restoreInputDefaultValue, 'press:tab');
        
        function submitInput(e) {
            e.preventDefault();
            if (input.get('value') != '' && input.get('value') != input_string) {
                var cfg = {
                    method: 'POST',
                    form: {
                        id: form,
                        useDisabled: true,
                    },
                    on: {
                        success: function(id, o, args) {
                            queryId(o.responseText);
                        },
                        failure: function(id, o, args) {
                            if (o.status == 400) {
                                subcontent.setContent('<p>The input field is required.</p>')
                            } else {
                                subcontent.setContent('<p>A general error occured. Please try again later.</p>')
                            }
                            busyStop();
                        }
                    },
                };
                
                busyStart(false);
                // Start the transaction.
                Y.io('{% url index %}?xhr', cfg);
            }
        };
        
        function getByDiscogsId(e) {
            e.preventDefault();
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        queryId(o.responseText);
                    },
                    failure: function(id, o, args) {
                        subcontent.setContent('<p>A general error occured. Please try again later.</p>')
                        busyStop();
                    }
                },
            };
            
            busyStart(false);
            Y.io(this.get('href') + '?xhr', cfg);
        };
        
        function queryId(id) {
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        var data = Y.JSON.parse(o.responseText);
                        
                        if (data[0] == 'result') {
                            var textarea = Y.Node.create('<textarea></textarea>');
                            textarea.addClass('wide');
                            //IE, I hate you...
                            if (Y.UA.ie > 0) {
                                textarea.set('text',data[1].replace(/\n/g,"\r\n"));
                            } else {
                                textarea.setContent(data[1]);
                            }
                            
                            var div = Y.Node.create('<div></div>');
                            div.addClass('form_settings');
                            div.insert(textarea,'replace');
                            
                            subcontent.setContent(div);
                            busyStop();
                        } else if (data[0] == 'list') {
                            var ul = Y.Node.create('<ul id="release_list"></ul>');
                            
                            var scraper_results = data[1];
                            for (scraper in scraper_results) {
                                var release_list = scraper_results[scraper];
                                for (var i = 0; i < release_list.length;i++) {
                                    var name = release_list[i]['name'],
                                        info = release_list[i]['info'],
                                        id = release_list[i]['release'];
                                    
                                    var li = Y.Node.create('<li></li>');
                                    var a = Y.Node.create('<a href="'+ '{% url get_by_id 121212 131313 %}'.replace(/121212/,scraper).replace(/131313/,id) + '">'+name+'</a>');
                                    a.on('key', getByDiscogsId, 'press:enter');
                                    a.on('click', getByDiscogsId);
                                    
                                    li.append(a);
                                    li.append('<br />')
                                    li.append(info);
                                    
                                    ul.append(li);
                                }
                            };
                            
                            if (ul.all('*').size() != 0) {
                                subcontent.setContent(ul);
                            } else {
                                subcontent.setContent('<p>Sorry, there were no matches.</p>');
                            }
                            busyStop();
                        } else if (data[0] == 'notfound') {
                            subcontent.setContent('<p>I could not find the release with the given ID on Discogs. You may want to try again with another one.</p>');
                            busyStop();
                        } else if (data[0] == 'waiting') {
                            var delay = function() { queryId(args.q_id); };
                            window.setTimeout(delay, 1000);
                        } else {
                            subcontent.setContent(o.responseText);
                            busyStop();
                        }
                    },
                    failure: function(id, o, args) {
                        if (o.status == 503) {
                            subcontent.setContent('<p>There was an error retrieving the data from discogs. This might be a temporary problem. Try again in a few minutes.</p>');
                        } else if (o.status == 404) {
                            subcontent.setContent('<p>Something happened that should not happen. Please try again.</p>');
                        } else {
                            subcontent.setContent('<p>A general error occured. Please try again later.</p>');
                        }
                        busyStop();
                    }
                },
                arguments: {
                    q_id: id,
                }
            };
            
            var uri = '{% url get_result '121212' %}'.replace(/121212/,id)+'?xhr';
            
            //circumvent IE's ajax caching
            if (Y.UA.ie > 0) {
                var date = new Date();
                var timestamp = date.getTime();
                
                uri = uri + '=' + timestamp;
            }
            
            Y.io(uri, cfg);
        };
        
        input.on('key', submitInput, 'press:enter');
        submit.on('key', submitInput, 'press:enter');
        submit.on('click', submitInput);
        
        //there may already be a release list on the page
        var release_links = Y.all('#release_list li a');
        
        //alter the default events for each link
        release_links.each( function(node,index,nodelist) {
            node.on('key', getByDiscogsId, 'press:enter');
            node.on('click', getByDiscogsId);
        });
    });
});
</script>
{% endblock %}

{% block content %}{% include "form.html" %}
<div id="subcontent">{% block subcontent %}{% endblock %}</div>{% endblock %}