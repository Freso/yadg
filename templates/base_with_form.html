{% extends "base.html" %}

{% block additionalHeaders %}<script src="http://yui.yahooapis.com/3.4.0/build/yui/yui-min.js"></script>

<script type="text/javascript">
YUI().use('node','event','io','json-parse','history', function (Y) {
    Y.on('domready', function(e) {
        var submit = Y.one('#submit'),
            input   = Y.one('#id_input'),
            select = Y.one('#id_scraper'),
            form = Y.one('form'),
            subcontent = Y.one('#subcontent'),
            url_match = /\/result\/([\w\d-]+)$/.exec(window.location),
            initial_result_id = '',
            initial_result_url = '',
            global_cache = {};
        
        // a little hacky solution to populate the initial state correctly, when we open a result url directly
        if (url_match != null) {
            initial_result_id = url_match[1];
            initial_result_url = "{% url api_v1_result 232323 %}".replace(/232323/,initial_result_id);
        }
        
        var history = new Y.History({
            initialState: {
                result_url: initial_result_url,
                result_id: initial_result_id,
                input: input.get('value'),
                select: select.get('value')
            }
        });
        
        Y.on('history:change', function (e) {
            var changed = e.changed,
                removed = e.removed;
            
            if (changed.result_url && changed.result_id) {
                var result_url = changed.result_url.newVal,
                    result_id = changed.result_id.newVal;
                
                input.set('value', history.get('input'));
                select.set('value', history.get('select'));
                
                if (result_url != '' && result_id != '') {
                    busyStart();
                    getResult(result_url, result_id);
                } else if (history.get('error') != undefined) {
                    subcontent.setContent(history.get('error'));
                } else {
                    subcontent.setContent('');
                }
            }
        });
    
        function busyStart(onlyBar) {
            if (!onlyBar) {
                submit.set('disabled',true);
                input.set('disabled',true);
                select.set('disabled',true);
                submit.set('value','Please wait...');
            }
            subcontent.setContent('<img class="center" src="{{ STATIC_URL }}img/ajax-loader.gif" alt="Loading" />');
        }
        
        function busyStop() {
            submit.set('disabled',false);
            input.set('disabled',false);
            select.set('disabled',false);
            submit.set('value','Fetch');
        }
        
        function appendGetParam(url,param) {
            if (url.charAt(url.length-1) == '/') {
                    url += '?';
            } else {
                    url += '&';
            }
            return url += param;
        }
        
        function appendFormatParam(url) {
            return appendGetParam(url,"format=json");
        }
        
        function makeQueryFromInput(e) {
            e.preventDefault();
            if (input.get('value') != '') {
                var cfg = {
                    method: 'GET',
                    form: {
                        id: form,
                        useDisabled: true,
                    },
                    on: {
                        success: function(id, o, args) {
                            var response = Y.JSON.parse(o.responseText);
                            
                            history.add({
                                input: args.input,
                                select: args.select,
                                result_url: response.result_url,
                                result_id: response.result_id,
                            }, {merge: false});
                            
                            getResult(response.result_url, response.result_id);
                        },
                        failure: function(id, o, args) {
                            if (o.status == 400) {
                                subcontent.setContent('<div class="alert alert-error">The input field is required.</div>')
                            } else {
                                subcontent.setContent('<div class="alert alert-error">A general error occured. Please try again later.</div>')
                            }
                            
                            history.add({
                                input: args.input,
                                select: args.select,
                                result_url: '',
                                result_id: '',
                                error: subcontent.getContent(),
                            }, {merge: false});
                            
                            busyStop();
                        }
                    },
                    arguments: {
                        input: input.get('value'),
                        select: select.get('value')
                    }
                };
                
                busyStart(false);
                
                Y.io(appendFormatParam('{% url api_v1_makequery %}'), cfg);
            }
        };
        
        function makeQueryFromLink(e) {
            e.preventDefault();
            
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        var response = Y.JSON.parse(o.responseText);
                        input.set('value',args.release_url);
                        
                        history.add({
                            input: input.get('value'),
                            select: args.select,
                            result_url: response.result_url,
                            result_id: response.result_id,
                        }, {merge: false});
                        
                        getResult(response.result_url, response.result_id);
                    },
                    failure: function(id, o, args) {
                        subcontent.setContent('<div class="alert alert-error">A general error occured. Please try again later.</div>')
                        
                        history.add({
                            input: args.input,
                            select: args.select,
                            result_url: '',
                            result_id: '',
                            error: subcontent.getContent(),
                        }, {merge: false});
                        
                        busyStop();
                    }
                },
                arguments: {
                    release_url: this.getAttribute('data-release-url'),
                    input: input.get('value'),
                    select: select.get('value')
                }
            };
            
            busyStart(false);
            Y.io(appendFormatParam(this.getAttribute('data-query-url')), cfg);
        };
        
        function changeFormat(e) {
            var format_form = this.get('parentNode'),
                url = format_form.getAttribute('data-api-action'),
                textarea = Y.Node.one('textarea#description_area'),
                loading_image = Y.Node.create('<img id="format_loading" src="{{ STATIC_URL }}img/ajax-loader.gif" alt="Loading" />'),
                format = this.get('value'),
                download_link = Y.Node.one('a#download_link');
            
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        var data = Y.JSON.parse(o.responseText);
                        args.download_link.set('href',args.download_link.get('href').replace(/[\w\d-]+$/,args.format));
                        
                        if (data.status == 'done' && data.type == 'release') {
                            args.textarea.set('value',data.description);
                            global_cache[args.format] = data.description;
                        }
                        
                        args.textarea.set('disabled',false);
                        args.select.set('disabled',false);
                        args.loading_image.remove();
                    },
                    failure: function(id, o, args) {
                        args.textarea.set('disabled',false);
                        args.select.set('disabled',false);
                        args.loading_image.remove();
                    }
                },
                arguments: {
                    select: this,
                    textarea: textarea,
                    loading_image: loading_image,
                    format: format,
                    download_link: download_link
                },
            };
            
            if (format in global_cache) {
                textarea.set('value',global_cache[format]);
                download_link.set('href',download_link.get('href').replace(/[\w\d-]+$/,format));
            } else {
                textarea.set('disabled',true);
                this.set('disabled',true);
                format_form.append(loading_image);
                
                Y.io(appendFormatParam(appendGetParam(url,'description_format=' + encodeURIComponent(format))), cfg);
            };
        }
        
        function getResult(result_url, result_id) {
            var cfg = {
                method: 'GET',
                on: {
                    success: function(id, o, args) {
                        //invalidate the cache
                        global_cache = {};
                        
                        var data = JSON.parse(o.responseText);
                        
                        if (data.status == "done") {
                            if (data.type == 'release') {
                                var textarea = Y.Node.create('<textarea id="description_area"></textarea>');
                                textarea.addClass('description_area');
                                textarea.set('value',data.description);
                                
                                var div = Y.Node.create('<div></div>');
                                div.addClass('well');
                                div.insert(textarea,'replace');
                                
                                var download_link = Y.Node.create('<a href="{% url download_result "121212" "343434" %}" id="download_link" class="btn">Download as .txt</a>'.replace(/343434/,data.description_format).replace(/121212/,args.result_id));
                                div.append(download_link);
                                
                                var format_form = Y.Node.create('{% with format_form=FORMAT_FORM %}{% spaceless %}{% include "format_form.html" %}{% endspaceless %}{% endwith %}');
                                format_form.set('action',args.result_url);
                                format_form.setAttribute('data-api-action', args.result_url);
                                format_form.one('#id_description_format').on('change',changeFormat);
                                
                                format_form.one('#id_description_format').get("options").each( function() {
                                    var selected = this.get('selected');
                                    var value  = this.get('value');
                                    
                                    if (value == data.description_format) {
                                        this.set('selected','selected');
                                    } else {
                                        this.removeAttribute('selected');
                                    }
                                });
                                
                                div.append(format_form);
                                
                                subcontent.setContent(div);
                            } else if (data.type == 'release_list') {
                                var ul = Y.Node.create('<ul id="release_list"></ul>');
                                
                                var scraper_results = data.releases;
                                for (scraper in scraper_results) {
                                    var release_list = scraper_results[scraper];
                                    for (var i = 0; i < release_list.length;i++) {
                                        var name = release_list[i]['name'],
                                            info = release_list[i]['info'],
                                            query_url = release_list[i]['query_url'],
                                            release_url = release_list[i]['release_url'];
                                        
                                        var li = Y.Node.create('<li></li>');
                                        var a = Y.Node.create('<a href="{% url index %}' + '?input=' + encodeURIComponent(release_url) +'">'+name+'</a>');
                                        a.setAttribute('data-query-url', query_url);
                                        a.setAttribute('data-release-url', release_url);
                                        a.on('key', makeQueryFromLink, 'press:enter');
                                        a.on('click', makeQueryFromLink);
                                        
                                        li.append(a);
                                        li.append('<br />')
                                        li.append('<span class="label">' + info + '</label>');
                                        
                                        ul.append(li);
                                    }
                                };
                                
                                if (ul.all('*').size() != 0) {
                                    var div = Y.Node.create('<div></div>');
                                    div.addClass('well');
                                    div.setContent(ul)
                                    
                                    subcontent.setContent(div);
                                } else {
                                    subcontent.setContent('<div class="alert alert-error">Sorry, there were no matches.</div>');
                                }
                            } else if (data.type == 'release_not_found') {
                                subcontent.setContent('<div class="alert alert-error">I could not find the release with the given ID. You may want to try again with another one.</div>');
                            } else {
                                subcontent.setContent(o.responseText);
                            }
                            busyStop();
                        } else if (data.status == 'failed') {
                            subcontent.setContent('<div class="alert alert-error">An error occured while retrieving the data. This might be a temporary problem. Try again in a few minutes.</div>');
                            busyStop();
                        } else {
                            var delay = function() { getResult(args.result_url, args.result_id); };
                            window.setTimeout(delay, 1000);
                        }
                    },
                    failure: function(id, o, args) {
                        if (o.status == 404) {
                            subcontent.setContent('<div class="alert alert-error">I was unable to find the data you were looking for. Please realize that the results of your request are purged periodically. You can of course make a new one at any time.</div>');
                        } else {
                            subcontent.setContent('<div class="alert alert-error">A general error occured. Please try again later.</div>');
                        }
                        busyStop();
                    }
                },
                arguments: {
                    result_url: result_url,
                    result_id: result_id
                },
            };
            
            //circumvent IE's ajax caching
            if (Y.UA.ie > 0) {
                var date = new Date();
                var timestamp = date.getTime();
                
                result_url = appendGetParam(result_url,'stupid_ie=' + timestamp)
            }
            
            Y.io(appendFormatParam(result_url), cfg);
        };
        
        input.on('key', makeQueryFromInput, 'press:enter');
        submit.on('key', makeQueryFromInput, 'press:enter');
        submit.on('click', makeQueryFromInput);
        
        //there may already be a release list on the page
        var release_links = Y.all('#release_list li a');
        
        //alter the default events for each link
        release_links.each( function(node,index,nodelist) {
            node.on('key', makeQueryFromLink, 'press:enter');
            node.on('click', makeQueryFromLink);
        });
        
        var format_select = Y.all('#id_description_format');
        format_select.each(function(node,index,nodelist) {
            node.on('change',changeFormat);
        });
    });
});
</script>
{% endblock %}

{% block content %}{% include "input_form.html" %}
<div id="subcontent">{% block subcontent %}{% endblock %}</div>{% endblock %}